{% extends "base.html" %}
{% load sample_metadata %}
{% load static %}
{% block content %}
    <h1>{{ sample.accession }}: {{ sample.title }}</h1>
    <p class="vf-lede">
        Sample data for {{ sample.accession }}, a HoloFood {{ sample.system }} sample includes: metadata from BioSamples and ENA, metagenomics, metabolomics.
    </p>
    <details class="vf-details" open>
        <summary class="vf-details--summary">
            Sample details
        </summary>
        <dl class="vf-list vf-list--definition">
            <dt class="vf-list__item vf-list--definition__term">
                Project
            </dt>
            <dd class="vf-list__item vf-list--definition__details">
                <a class="vf-link"
                   href="{% url 'samples_list' %}?project__accession__icontains={{ sample.project.accession }}">
                    {{ sample.project.accession }}: {{ sample.project.title }}
                </a>
            </dd>
            <dt class="vf-list__item vf-list--definition__term">
                System
            </dt>
            <dd class="vf-list__item vf-list--definition__details">
                <a class="vf-link"
                   href="{% url 'samples_list' %}?system={{ sample.system }}">{{ sample.system }}</a>
            </dd>
            <dt class="vf-list__item vf-list--definition__term">
                API endpoint
            </dt>
            {% url 'api:sample_detail' sample_accession=sample.accession as endpoint %}
            <dd class="vf-list__item vf-list--definition__details">
                <span class="api-endpoint">
                    <a class="vf-link" href="{{ endpoint }}">{{ endpoint }}</a>
                    <span class="tooltiped">
                        <button class="vf-button vf-button--link vf-button--sm inline"
                            onclick="copyApiEndpoint()">
                            <img src="{% static 'img/icons/copy.svg' %}" height="16px" alt="Copy"/>
                        </button>
                        <span id="endpoint-copy-tooltip" class="tooltip-text">Copy API Endpoint</span>
                    </span>

                </span>
            </dd>
        </dl>
    </details>
    <script>
        function copyApiEndpoint(e) {
            navigator.clipboard.writeText('{{ endpoint }}');
            window.document.getElementById('endpoint-copy-tooltip').textContent = "Copied!";
        }
    </script>
    <details class="vf-details">
        <summary class="vf-details--summary">
            Sample metadata
        </summary>
        <p class="vf-text-body">Metadata for sample {{ sample.accession }}, stored in BioSamples and ENA.</p>
        <a class="vf-button vf-button--link vf-button--sm"
           href="{% url 'export:sample_metadata_list' sample_accession=sample.accession %}"><i class="icon icon-common icon-download"></i>&nbsp;Download all as TSV</a>

        <div class="autoComplete_wrapper">
            <input id="typeahead" type="search" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off" autocapitalize="off"/>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>
        <script>
            const autoCompleteJS = new autoComplete({
                selector: "#typeahead",
                placeHolder: "Search metadata markers",
                data: {
                    src: [
                        {% for metadatum in sample.structured_metadata.all %}
                            {name: "{{ metadatum.marker.name }}", type: "{{ metadatum.marker.type }}"},
                        {% endfor %}
                    ],
                    keys: ["name"],
                    cache: true,
                },
                resultItem: {
                    highlight: true
                },
                resultsList: {
                    class: "typeahead-results",
                    position: "beforebegin"
                },
                events: {
                    input: {
                        selection: (event) => {
                            const selection = event.detail.selection.value.name;
                            autoCompleteJS.input.value = selection;

                            const tabPanels = document.querySelectorAll(
                                "[data-vf-js-tabs-content] [id^=\"vf-tabs__section\"]"
                            );
                            const tabForSelectedMarker = document.querySelector(
                                `[data-vf-js-tabs] .vf-tabs__link[data-metadata-type-key="${event.detail.selection.value.type}"] `
                            );
                            vfTabsSwitch(tabForSelectedMarker, tabPanels);

                        },
                        navigate: (event) => {
                            Array.from(document.querySelectorAll('.highlight-tab-match'))
                                .forEach((el) => el.classList.remove('highlight-tab-match'));
                            Array.from(document.querySelectorAll('.highlight-tab-select'))
                                .forEach((el) => el.classList.remove('highlight-tab-select'));

                            const matchingDataTypes = [... new Set(event.detail.matches.map(match => match.value.type))];
                            matchingDataTypes.forEach((metadataKey => {
                                const tabs = document.querySelector(`[data-metadata-type-key="${metadataKey}"]`);
                                tabs.classList.add("highlight-tab-match");
                            }));

                            document.querySelector(
                                `[data-metadata-type-key="${event.detail.selection.value.type}"]`
                            ).classList.add("highlight-tab-select");
                        }
                    }
                }
            });
        </script>

        {% regroup sample.structured_metadata.all by marker.type as metadata_sections %}
        <div class="vf-tabs">
            <ul class="vf-tabs__list" data-vf-js-tabs id="metadata-sections-tabs">
                {% for metadata_section in metadata_sections %}
                    <li class="vf-tabs__item">
                        <a class="vf-tabs__link"
                           data-metadata-type-key="{{ metadata_section.grouper }}"
                           href="#vf-tabs__section--{{ metadata_section.grouper|lower|cut:" " }}">{{ metadata_section.grouper|default:"Generic"|title }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div class="vf-tabs-content" data-vf-js-tabs-content>
            {% for metadata_section in metadata_sections %}
                <section class="vf-tabs__section"
                         id="vf-tabs__section--{{ metadata_section.grouper|lower|cut:" " }}">
                    <h2>{{ metadata_section.grouper|default:"Generic"|title }} metadata</h2>
                    <table class="vf-table scrollable-table">
                        <thead class="vf-table__header">
                            <tr class="vf-table__row">
                                <th class="vf-table__heading" scope="col">Marker</th>
                                <th class="vf-table__heading" scope="col">Measurement</th>
                                <th class="vf-table__heading" scope="col">Units</th>
                            </tr>
                        </thead>
                        <tbody class="vf-table__body">
                            {% for structured_metadatum in metadata_section.list|holofood_ordering_rules %}
                                <tr class="vf-table__row">
                                    <td class="vf-table__cell">{{ structured_metadatum.marker.name }}</td>
                                    <td class="vf-table__cell">{{ structured_metadatum.measurement }}</td>
                                    <td class="vf-table__cell">{{ structured_metadatum.units }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </section>
            {% endfor %}
        </div>
    </details>
    <details class="vf-details">
        <summary class="vf-details--summary">
            Metagenomics
        </summary>
        {% if sample.has_metagenomics %}
            <p>
                Sample {{ sample.accession }} has metagenomic datasets available on MGnify.
                <a class="vf-button vf-button--link vf-button--sm"
                   href="{{ MGNIFY_WEB_URL }}/samples/{{ sample.accession }}">View sample on MGnify</a>
            </p>
            <table class="vf-table scrollable-table">
                <thead class="vf-table__header">
                    <tr class="vf-table__row">
                        <th class="vf-table__heading" scope="col">Analysis accession</th>
                        <th class="vf-table__heading" scope="col">Run accession</th>
                        <th class="vf-table__heading" scope="col">MGnify pipeline version</th>
                        <th class="vf-table__heading" scope="col">Experiment type</th>
                        <th class="vf-table__heading" scope="col">Detail</th>
                    </tr>
                </thead>
                <h3>Analyses</h3>
                <tbody class="vf-table__body">
                    {% if analyses_error %}
                        <article class="vf-card vf-card--hf vf-card--bordered error vf-grid__col--span-{{ colspan|default:1 }}">
                            <div class="vf-card__content | vf-stack vf-stack--400">
                                <div class="vf-flag vf-flag--middle vf-flag--400">
                                    <div class="vf-flag__media">
                                        <img src="{% static 'img/icons/empty-egg.svg' %}"
                                             height="36px"
                                             width="36px"
                                             alt="Empty set icon"/>
                                    </div>
                                    <div class="vf-flag__body">
                                        <p class="vf-card__subheading">Could not connect to MGnify right now. Please try later.</p>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% endif %}
                    {% for analysis in analyses %}
                        <tr class="vf-table__row">
                            <td class="vf-table__cell">
                                <a href="{{ MGNIFY_WEB_URL }}/analyses/{{ analysis.id }}"
                                   class="vf-link">{{ analysis.id }}</a>
                            </td>
                            <td class="vf-table__cell">
                                <a href="{{ MGNIFY_WEB_URL }}/runs/{{ analysis.relationships.run.data.id }}"
                                   class="vf-link">
                                    {{ analysis.relationships.run.data.id }}
                                </a>
                            </td>
                            <td class="vf-table__cell">{{ analysis.attributes.pipeline_version }}</td>
                            <td class="vf-table__cell">{{ analysis.attributes.experiment_type }}</td>
                            <td class="vf-table__cell">
                                <a class="vf-button vf-button--link vf-button--sm inline"
                                   href="{{ MGNIFY_WEB_URL }}/analyses/{{ analysis.id }}">
                                    View on MGnify
                                </a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Sample {{ sample.accession }} has no metagenomics data</p>
        {% endif %}
    </details>
    <details class="vf-details">
        <summary class="vf-details--summary">
            Metabolomics
        </summary>
        <p>
            Sample {{ sample.accession }} may have metabolomics analysis on MetaboLights.
        </p>
        <a href="{{ METABOLIGHTS_WEB_URL }}" class="vf-button vf-button--primary vf-button--sm" target="_blank">Open MetaboLights</a>
    </details>
    <section class="vf-card-container vf-card-container__col-3 | vf-u-background-color--grey--lightest vf-u-fullbleed">
        <div class="vf-card-container__inner">
            <div class="vf-section-header">
                <h2 class="vf-section-header__heading">
                    Analysis summaries
                </h2>
                <p class="vf-section-header__text">
                    Documents written by HoloFood partners and collaborators relevant to Sample {{ sample.accession }}
                </p>
            </div>
            {% for annotation in sample.annotations.all %}
                {% include 'holofood/components/annotation_card.html' with annotation=annotation %}
            {% endfor %}
            {% include 'holofood/components/atoms/possibly_empty_state.html' with items=sample.annotations empty_text="No summaries mention this sample directly" colspan=3 %}

            <div class="vf-section-header">
                <p class="vf-section-header__text">
                    Documents relevant to Sample’s Project {{ sample.project.accession }}
                </p>
            </div>
            {% for annotation in sample.project.annotations.all %}
                {% include 'holofood/components/annotation_card.html' with annotation=annotation %}
            {% endfor %}
            {% include 'holofood/components/atoms/possibly_empty_state.html' with items=sample.project.annotations empty_text="No summaries mention this sample’s project" colspan=3 %}
        </div>
    </section>
{% endblock content %}
